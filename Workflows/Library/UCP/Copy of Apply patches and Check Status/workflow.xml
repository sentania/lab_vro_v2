<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item15" object-name="workflow:name=generic" id="1d4f7a04-4c10-4695-8d93-b9d79b4f266a" version="0.0.1" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Copy of Apply patches and Check Status]]></display-name>
  <position y="0.0" x="105.0"/>
  <input>
    <param name="vRAVirtualMachine" type="VC:VirtualMachine"/>
  </input>
  <attrib name="deployStatusCode" type="Number" read-only="false">
    <description><![CDATA[Response status code]]></description>
  </attrib>
  <attrib name="deployContentLength" type="Number" read-only="false">
    <description><![CDATA[Response content length]]></description>
  </attrib>
  <attrib name="deployHeaders" type="Properties" read-only="false">
    <description><![CDATA[Response headers]]></description>
  </attrib>
  <attrib name="deployContentAsString" type="String" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Response content as string]]></description>
  </attrib>
  <attrib name="jobStatusID" type="number" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
    <description><![CDATA[The Job ID to check for a status]]></description>
  </attrib>
  <attrib name="statusCode" type="Number" read-only="false">
    <description><![CDATA[Response status code]]></description>
  </attrib>
  <attrib name="statusContentLength" type="Number" read-only="false">
    <description><![CDATA[Response content length]]></description>
  </attrib>
  <attrib name="statusHeaders" type="Properties" read-only="false">
    <description><![CDATA[Response headers]]></description>
  </attrib>
  <attrib name="statusContentAsString" type="String" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Response content as string]]></description>
  </attrib>
  <attrib name="currentStatus" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Current status of job ]]></description>
  </attrib>
  <attrib name="sleepTime" type="number" read-only="false">
    <value encoded="n"><![CDATA[60.0]]></value>
    <description><![CDATA[Time to sleep in seconds]]></description>
  </attrib>
  <attrib name="counter" type="number" read-only="false">
    <value encoded="n"><![CDATA[0.0]]></value>
    <description><![CDATA[counter to increment]]></description>
  </attrib>
  <attrib name="errorCode" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[ERROR!]]></description>
  </attrib>
  <attrib name="sleepTime10" type="number" read-only="false">
    <value encoded="n"><![CDATA[10.0]]></value>
    <description><![CDATA[Time to sleep in seconds]]></description>
  </attrib>
  <attrib name="os" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Guest Operating System
]]></description>
  </attrib>
  <attrib name="serverName" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Name of the server to be patched]]></description>
  </attrib>
  <workflow-note x="60.0" y="36.36363636363636" w="500.0" h="146.54545454545453">
    <description><![CDATA[Run Job in Ansible Tower]]></description>
  </workflow-note>
  <workflow-note x="580.0" y="116.18181818181816" w="404.0" h="128.0" color="a1d7d7ff">
    <description><![CDATA[Check status of Job]]></description>
  </workflow-note>
  <workflow-item name="item2" out-name="item4" type="link" linked-workflow-id="ce28b43f-0b9c-4eb6-9ffd-d66193b18f25">
    <display-name><![CDATA[Check Job Status]]></display-name>
    <in-binding>
      <bind name="jobID" type="number" export-name="jobStatusID">
        <description><![CDATA[jobID]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="statusCode" type="Number" export-name="statusCode">
        <description><![CDATA[Response status code]]></description>
      </bind>
      <bind name="contentLength" type="Number" export-name="statusContentLength">
        <description><![CDATA[Response content length]]></description>
      </bind>
      <bind name="headers" type="Properties" export-name="statusHeaders">
        <description><![CDATA[Response headers]]></description>
      </bind>
      <bind name="contentAsString" type="String" export-name="statusContentAsString">
        <description><![CDATA[Response content as string]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Autogenerated workflow.]]></description>
    <position y="137.22727272727272" x="584.5"/>
  </workflow-item>
  <workflow-item name="item3" out-name="item14" type="task">
    <display-name><![CDATA[Get Job ID]]></display-name>
    <script encoded="false"><![CDATA[var obj = JSON.parse(deployContentAsString);

var jobStatusID = obj.job;
//jobStatusID.toString();

System.log("Checking the status of Job: "+jobStatusID);]]></script>
    <in-binding>
      <bind name="deployContentAsString" type="String" export-name="deployContentAsString"/>
    </in-binding>
    <out-binding>
      <bind name="jobStatusID" type="number" export-name="jobStatusID"/>
    </out-binding>
    <position y="137.22727272727272" x="244.5"/>
  </workflow-item>
  <workflow-item name="item4" out-name="item5" type="task">
    <display-name><![CDATA[Get Status]]></display-name>
    <script encoded="false"><![CDATA[var obj = JSON.parse(statusContentAsString);

var currentStatus = obj.status;
]]></script>
    <in-binding>
      <bind name="statusContentAsString" type="String" export-name="statusContentAsString"/>
    </in-binding>
    <out-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </out-binding>
    <position y="137.22727272727272" x="724.5"/>
  </workflow-item>
  <workflow-item name="item5" out-name="item6" type="custom-condition" alt-out-name="item10">
    <display-name><![CDATA[Running?]]></display-name>
    <script encoded="false"><![CDATA[if(currentStatus == "running" || currentStatus == "pending" || currentStatus == "waiting") {
	return true;
} else { 
	return false;
}]]></script>
    <in-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </in-binding>
    <position y="127.22727272727272" x="864.5"/>
  </workflow-item>
  <workflow-item name="item0" prototype-id="sleep" out-name="item2" content-mode="x" type="task">
    <display-name><![CDATA[Sleep]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
if ( sleepTime != null )  {
	System.sleep(sleepTime*1000);
}
else  {
	throw "'sleepTime' is NULL";
}
]]></script>
    <in-binding>
      <bind name="sleepTime" type="number" export-name="sleepTime">
        <description><![CDATA[Time to sleep in seconds]]></description>
      </bind>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Sleep a given number of seconds]]></description>
    <position y="200.86363636363635" x="584.5"/>
  </workflow-item>
  <workflow-item name="item6" prototype-id="increase-counter" out-name="item7" content-mode="x" type="task">
    <display-name><![CDATA[Increase counter]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
counter = counter+1;]]></script>
    <in-binding>
      <bind name="counter" type="number" export-name="counter">
        <description><![CDATA[counter to increment]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="counter" type="number" export-name="counter">
        <description><![CDATA[counter incremented]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Increment a counter by one]]></description>
    <position y="200.86363636363635" x="864.5"/>
  </workflow-item>
  <workflow-item name="item7" out-name="item0" type="custom-condition" alt-out-name="item9">
    <display-name><![CDATA[Threshold Met?]]></display-name>
    <script encoded="false"><![CDATA[if(counter < 120) {
	return true;
} else {
	return false;
}]]></script>
    <in-binding>
      <bind name="counter" type="number" export-name="counter"/>
    </in-binding>
    <position y="190.86363636363635" x="724.5"/>
  </workflow-item>
  <workflow-item name="item8" throw-bind-name="errorCode" type="end" end-mode="1">
    <position y="318.1363636363636" x="764.5"/>
  </workflow-item>
  <workflow-item name="item9" out-name="item8" type="task">
    <display-name><![CDATA[Form Error Code]]></display-name>
    <script encoded="false"><![CDATA[errorCode = "Ansible has failed to apply configuration to "+serverName+" through Job ID "+jobStatusID+" in a timely manner. It's current status is: "+currentStatus+".";]]></script>
    <in-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
      <bind name="jobStatusID" type="number" export-name="jobStatusID"/>
      <bind name="serverName" type="string" export-name="serverName"/>
    </in-binding>
    <out-binding>
      <bind name="errorCode" type="string" export-name="errorCode"/>
    </out-binding>
    <position y="264.5" x="724.5"/>
  </workflow-item>
  <workflow-item name="item10" out-name="item11" type="custom-condition" alt-out-name="item12">
    <display-name><![CDATA[Success?]]></display-name>
    <script encoded="false"><![CDATA[if(currentStatus == "successful") {
	return true;
} else {
	return false;
}]]></script>
    <in-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </in-binding>
    <position y="127.22727272727272" x="1004.5"/>
  </workflow-item>
  <workflow-item name="item11" type="end" end-mode="0">
    <position y="127.22727272727272" x="1204.5"/>
  </workflow-item>
  <workflow-item name="item12" out-name="item13" type="task">
    <display-name><![CDATA[Form Failure Code]]></display-name>
    <script encoded="false"><![CDATA[errorCode = "Ansible has failed to apply configuration to "+serverName+" through Job ID "+jobStatusID+".";]]></script>
    <in-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
      <bind name="jobStatusID" type="number" export-name="jobStatusID"/>
      <bind name="serverName" type="string" export-name="serverName"/>
    </in-binding>
    <out-binding>
      <bind name="errorCode" type="string" export-name="errorCode"/>
    </out-binding>
    <position y="200.86363636363635" x="1004.5"/>
  </workflow-item>
  <workflow-item name="item13" throw-bind-name="errorCode" type="end" end-mode="1">
    <position y="190.86363636363635" x="1184.5"/>
  </workflow-item>
  <workflow-item name="item14" prototype-id="sleep" out-name="item2" content-mode="x" type="task">
    <display-name><![CDATA[Sleep10]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
if ( sleepTime != null )  {
	System.sleep(sleepTime*1000);
}
else  {
	throw "'sleepTime' is NULL";
}
]]></script>
    <in-binding>
      <bind name="sleepTime" type="number" export-name="sleepTime10">
        <description><![CDATA[Time to sleep in seconds]]></description>
      </bind>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Sleep a given number of seconds]]></description>
    <position y="137.22727272727272" x="444.5"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item3" type="link" linked-workflow-id="6e1252ad-e534-4553-af10-e0a6c1798769">
    <display-name><![CDATA[Apply Patches]]></display-name>
    <in-binding>
      <bind name="os" type="string" export-name="os">
        <description><![CDATA[Operating System of the guest server]]></description>
      </bind>
      <bind name="serverName" type="string" export-name="serverName">
        <description><![CDATA[Server name to apply the post deploy configuration]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="statusCode" type="Number" export-name="deployStatusCode">
        <description><![CDATA[Response status code]]></description>
      </bind>
      <bind name="contentLength" type="Number" export-name="deployContentLength">
        <description><![CDATA[Response content length]]></description>
      </bind>
      <bind name="headers" type="Properties" export-name="deployHeaders">
        <description><![CDATA[Response headers]]></description>
      </bind>
      <bind name="contentAsString" type="String" export-name="deployContentAsString">
        <description><![CDATA[Response content as string]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Autogenerated workflow.]]></description>
    <position y="137.22727272727272" x="64.5"/>
  </workflow-item>
  <workflow-item name="item15" out-name="item1" type="task">
    <display-name><![CDATA[Define Variables]]></display-name>
    <script encoded="false"><![CDATA[var os = vRAVirtualMachine.guestOS;
var serverName = vRAVirtualMachine.name]]></script>
    <in-binding>
      <bind name="vRAVirtualMachine" type="VC:VirtualMachine" export-name="vRAVirtualMachine"/>
    </in-binding>
    <out-binding>
      <bind name="os" type="string" export-name="os"/>
      <bind name="serverName" type="string" export-name="serverName"/>
    </out-binding>
    <position y="73.59090909090908" x="65.0"/>
  </workflow-item>
  <presentation>
    <p-param name="vRAVirtualMachine">
      <desc><![CDATA[vRAVirtualMachine]]></desc>
    </p-param>
  </presentation>
</workflow>